name: http test description
id: http
runnables:
- timeout: 3000
  startEvent:
    publisher:
      name: publisher description
      type: http-client
      url: http://localhost:23075/enqueuer/idStuff?query=000
      method: POST
      payload:
        enqueuer: virgs
      headers:
        content-type: application/json
      authentication:
        basic:
          user: user
          password: password
      onMessageReceived:
        assertions:
        - name: Status Code
          expect: statusCode
          toBeEqualTo: 321
        - name: Body
          expect: body
          toBeEqualTo: `dynamically changed payload`
  subscriptions:
  - name: subscription description
    type: http-server
    endpoint: /enqueuer/:firstId
    port: 23075
    method: POST
    timeout: 10000
    authentication:
      basic:
        user: user
        password: password
    response:
      status: 321
      payload: responsePayload
    onMessageReceived:
      script: subscription.response.payload = 'dynamically changed payload'
      assertions:
      - name: Payload
        expect: JSON.parse(message.body).enqueuer
        toBeEqualTo: `virgs`
      - name: Params
        expect: params.firstId
        toBeEqualTo: `idStuff`
      - name: Query
        expect: query.query
        toBeEqualTo: 000
- name: requisition 1 description
  timeout: 5000
  startEvent:
    publisher:
      name: publisher description
      type: http-client
      url: http://localhost:23075/enqueuer/idStuff?query=111
      method: POST
      payload:
        duplicated: true
      headers:
        content-type: application/json
      onMessageReceived:
        assertions:
        - name: Status Code
          expect: statusCode
          toBeEqualTo: 321
        - name: Body
          expect: body
          toBeEqualTo: `duplicatedResponsePayload`
  subscriptions:
  - name: subscription description
    type: http-server
    endpoint: /enqueuer/:secondId
    port: 23075
    method: POST
    timeout: 10000
    response:
      status: 321
      payload: duplicatedResponsePayload
    onMessageReceived:
      assertions:
      - name: Payload
        expectToBeTruthy: JSON.parse(message.body).duplicated
- name: requisition 2 (different port) description
  timeout: 5000
  startEvent:
    subscription:
      name: subscription description
      type: http-server
      endpoint: /differentPort
      port: 23076
      method: POST
      timeout: 1000
      avoid: true
- name: requisition 3 (check port releasing)
  timeout: 5000
  startEvent:
    subscription:
      name: same port subscription
      type: tcp-server
      port: 23075
      timeout: 1000
      avoid: true
- name: requisition https
  timeout: 3000
  startEvent:
    publisher:
      name: publisher description
      type: https-client
      url: https://localhost:4430/enqueuer
      method: POST
      payload:
        https: works!
      headers:
        content-type: application/json
      onMessageReceived:
        assertions:
        - name: Status Code
          expect: statusCode
          toBeEqualTo: 200
        - name: Body
          expect: body
          toBeEqualTo: `https`
  subscriptions:
  - type: https-server
    name: subscription description
    endpoint: /enqueuer
    port: 4430
    method: POST
    timeout: 1000
    credentials: <<httpsCredentials>>
    response:
      status: 200
      payload: https
    onMessageReceived:
      assertions:
      - name: Https payload
        expect: JSON.parse(message.body).https
        toBeEqualTo: `works!`
